
#Cliente

#funcion para mover el servo a un angulo determinado(esta funcion solo mueve el servo a el angulo y se detiene NO mantiene la posicion si una fuerza extenrna lo mueve) 
def servo(pin,angulo):
  for i in range(50):
    pausa = int((float(angulo)*2000.0/180.0)+425.0)
    Pin(pin, Pin.OUT, value=1)
    utime.sleep_us(pausa)
    Pin(pin, Pin.OUT, value=0)
    utime.sleep_us(20000-pausa)

# esta funcion despliega el sitio web para controlar el interruptor virtual (para ver con mas detalle el sito vea el archivo index.html y style.css)
def web_page():
  if led.value() == 1:
    gpio_state="1"
  else:
    gpio_state="0"
  css = r"""<style type="text/css">button{font-family:Helvetica,Arial,sans-serif;position:relative;color:#cfcfcf;font-size:2em;cursor:pointer;background:#efefef;background:-moz-linear-gradient(top,rgba(239,239,239,1) 25%,rgba(226,226,226,1) 50%,rgba(239,239,239,1) 75%);background:-webkit-gradient(linear,left top,left bottom,color-stop(25%,rgba(239,239,239,1)),color-stop(50%,rgba(226,226,226,1)),color-stop(75%,rgba(239,239,239,1)));background:-webkit-linear-gradient(top,rgba(239,239,239,1) 25%,rgba(226,226,226,1) 50%,rgba(239,239,239,1) 75%);background:-o-linear-gradient(top,rgba(239,239,239,1) 25%,rgba(226,226,226,1) 50%,rgba(239,239,239,1) 75%);background:-ms-linear-gradient(top,rgba(239,239,239,1) 25%,rgba(226,226,226,1) 50%,rgba(239,239,239,1) 75%);background:linear-gradient(top,rgba(239,239,239,1) 25%,rgba(226,226,226,1) 50%,rgba(239,239,239,1) 75%);width:300px;height:400px;padding:70px 0 70px 0;border:none;-moz-box-shadow:0 3px 10px 1px #894e30,0 0 1px 2px #917760,inset 0 -6px 2px rgba(0,0,0,"""+""".15),inset 0 5px 2px rgba(0,0,0,.1),inset 0 12px 2px #fff;-webkit-box-shadow:0 3px 10px 1px #894e30,0 0 1px 2px #917760,inset 0 -6px 2px rgba(0,0,0,"""+""".15),inset 0 5px 2px rgba(0,0,0,.1),inset 0 12px 2px #fff;box-shadow:0 3px 10px 1px #894e30,0 0 1px 2px #917760,inset 0 -6px 2px rgba(0,0,0,.15),inset 0 5px 2px rgba(0,0,0,.1),inset 0 12px 2px #fff;-moz-border-radius:60px;-webkit-border-radius:60px;border-radius:60px;-webkit-tap-highlight-color:transparent;outline:0}button::-moz-focus-inner"""+r"""{border:0}button span:after,button span:before,button:after,button:before{font-size:"""+""".5em;font-weight:700;color:#999;text-shadow:0 1px 0 #fff;position:absolute;top:25px;left:30px;width:21px;height:21px;line-height:21px;-moz-border-radius:60px;-webkit-border-radius:60px;border-radius:60px;-moz-box-shadow:0 2px 1px #fff,inset 0 1px 1px #aaa,inset 0 2px 2px #999,inset 0 8px 4px rgba(255,255,255,.5),inset 0 0 5px rgba(0,0,0,.1);-webkit-box-shadow:0 2px 1px #fff,inset 0 1px 1px #aaa,inset 0 2px 2px #999,inset 0 8px 4px rgba(255,255,255,.5),inset 0 0 5px rgba(0,0,0,.1);box-shadow:0 2px 1px #fff,inset 0 1px 1px #888,inset 0 2px 3px #999,inset 0 8px 4px rgba(255,255,255,.7),inset 0 0 10px rgba(0,0,0,.1);background:-moz-linear-gradient(top,rgba(152,152,152,0) 0,rgba(255,255,255,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(152,152,152,0)),color-stop(100%,rgba(255,255,255,1)));background:-webkit-linear-gradient(top,rgba(152,152,152,0) 0,rgba(255,255,255,1) 100%);background:-o-linear-gradient(top,rgba(152,152,152,0) 0,rgba(255,255,255,1) 100%);background:-ms-linear-gradient(top,rgba(152,152,152,0) 0,rgba(255,255,255,1) 100%);background:linear-gradient(top,rgba(152,152,152,0) 0,rgba(255,255,255,1) 100%)}button:after{left:auto;right:30px}button span:before{left:-90px;top:278px}button span:after{top:278px;left:auto;right:-90px}button span{width:160px;z-index:1;position:relative;height:250px;display:block;margin:0 auto;-moz-border-radius:40px;-webkit-border-radius:40px;border-radius:40px;background:#fff;-moz-box-shadow:inset 0 0 1px 1px #ccc,inset 0 0 0 8px #ddd,inset 0 0 0 10px #888,inset 0 10px 0 10px #fff;-webkit-box-shadow:inset 0 0 1px 1px #ccc,inset 0 0 0 8px #ddd,inset 0 0 0 10px #888,inset 0 10px 0 10px #fff;box-shadow:inset 0 0 1px 1px #ccc,inset 0 0 0 8px #ddd,inset 0 0 0 10px #888,inset 0 10px 0 10px #fff}button span>b:first-child"""+r"""{position:absolute;text-shadow:0 -1px 0 #666,0 1px 0 #fff;top:11px;left:10px;height:70%;width:140px;padding-top:10px;color:#ccc;-moz-border-radius:31px;-webkit-border-radius:31px;border-radius:31px;background:#e5e5e5;background:-moz-linear-gradient(top,rgba(229,229,229,1) 0,rgba(255,255,255,1) 60%,rgba(255,255,255,1) 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(229,229,229,1)),color-stop(60%,rgba(255,255,255,1)),color-stop(100%,rgba(255,255,255,1)));background:-webkit-linear-gradient(top,rgba(229,229,229,1) 0,rgba(255,255,255,1) 60%,rgba(255,255,255,1) 100%);background:-o-linear-gradient(top,rgba(229,229,229,1) 0,rgba(255,255,255,1) 60%,rgba(255,255,255,1) 100%);background:-ms-linear-gradient(top,rgba(229,229,229,1) 0,rgba(255,255,255,1) 60%,rgba(255,255,255,1) 100%);background:linear-gradient(top,rgba(229,229,229,1) 0,rgba(255,255,255,1) 60%,rgba(255,255,255,1) 100%);-moz-box-shadow:inset 0 7px 10px rgba(0,0,0,.07);-webkit-box-shadow:inset 0 7px 10px rgba(0,0,0,.07);box-shadow:inset 0 7px 10px rgba(0,0,0,.07)}button span>b:last-child{position:absolute;bottom:17%;color:#eee;text-shadow:0 -1px 0 #ddd,0 1px 0 #fff;width:140px;height:18%;left:10px;padding-top:20px;-moz-border-radius:40px;-webkit-border-radius:40px;border-radius:40px;background:#fff}button span>b:last-child:before{content:"";position:absolute;background:rgba(0,0,0,"""+""".2);top:17px;left:0;width:140px;height:80px;-moz-border-radius:30px;-webkit-border-radius:35px;border-radius:30px;z-index:-1;-moz-box-shadow:inset 0 -10px 10px rgba(255,255,255,.2),0 15px 20px 2px rgba(0,0,0,.2),0 50px 30px 2px rgba(0,0,0,.1);-webkit-box-shadow:inset 0 -10px 10px rgba(255,255,255,.2),0 15px 20px 2px rgba(0,0,0,.2),0 50px 30px 2px rgba(0,0,0,.1);box-shadow:inset 0 -10px 10px rgba(255,255,255,.2),0 15px 20px 2px rgba(0,0,0,.2),0 50px 30px 2px rgba(0,0,0,.1)}button.off span{-moz-box-shadow:inset 0 0 1px 1px #ccc,inset 0 0 0 8px #ddd,inset 0 0 0 10px #888,inset 0 10px 2px 1px rgba(0,0,0,.15),inset 0 10px 6px rgba(0,0,0,.5),inset 0 14px 14px rgba(0,0,0,.3),inset 0 40px 0 #fff;-webkit-box-shadow:inset 0 0 1px 1px #ccc,inset 0 0 0 8px #ddd,inset 0 0 0 10px #888,inset 0 10px 2px 1px rgba(0,0,0,.15),inset 0 10px 6px rgba(0,0,0,.5),inset 0 14px 14px rgba(0,0,0,.3),inset 0 40px 0 #fff;box-shadow:inset 0 0 1px 1px #ccc,inset 0 0 0 8px #ddd,inset 0 0 0 10px #888,inset 0 10px 2px 1px rgba(0,0,0,.15),inset 0 10px 6px rgba(0,0,0,.5),inset 0 14px 14px rgba(0,0,0,.3),inset 0 40px 0 #fff}button.off span>b:first-child"""+r"""{color:#aaa;top:18%;left:12px;height:70%;width:136px;padding-top:10px;-moz-border-radius:35px;-webkit-border-radius:35px;border-radius:35px;background:#d8d8d8;background:-moz-linear-gradient(top,rgba(216,216,216,1) 0,rgba(255,255,255,1) 72%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba(216,216,216,1)),color-stop(72%,rgba(255,255,255,1)));background:-webkit-linear-gradient(top,rgba(216,216,216,1) 0,rgba(255,255,255,1) 72%);background:-o-linear-gradient(top,rgba(216,216,216,1) 0,rgba(255,255,255,1) 72%);background:-ms-linear-gradient(top,rgba(216,216,216,1) 0,rgba(255,255,255,1) 72%);background:linear-gradient(top,rgba(216,216,216,1) 0,rgba(255,255,255,1) 72%)}button"""+""".off span>b:last-child"""+r"""{position:absolute;text-shadow:0 -1px 0 #bbb,0 1px 0 #fff;color:#dfdfdf;top:auto;bottom:7%;left:6%;background:0 0}button"""+""".off span>b:last-child:before{display:none}.dark"""+r"""{display:none;position:absolute;top:0;left:0;width:100%;height:110%;background:#000!important;z-index:1000;-moz-opacity:"""+""".9;opacity:.9}body,html"""+r"""{height:100%;overflow:hidden;background-attachment:fixed;background: #000;margin:0}body{background:-moz-radial-gradient(center,ellipse cover,rgba(237,237,237,0) 0,rgba(61,22,9,"""+""".63) 100%);background:-webkit-gradient(radial,center center,0,center center,100%,color-stop(0,rgba(237,237,237,0)),color-stop(100%,rgba(61,22,9,.63)));background:-webkit-radial-gradient(center,ellipse cover,rgba(237,237,237,0) 0,rgba(61,22,9,.63) 100%);background:-o-radial-gradient(center,ellipse cover,rgba(237,237,237,0) 0,rgba(61,22,9,.63) 100%);background:-ms-radial-gradient(center,ellipse cover,rgba(237,237,237,0) 0,rgba(61,22,9,.63) 100%);background:radial-gradient(center,ellipse cover,rgba(237,237,237,0) 0,rgba(61,22,9,.63) 100%);text-align:center;padding-top:10%}footer{font-size:12px;font-weight:700;font-family:Helvetica,Arial,sans-serif;line-height:1.6em;margin-top:2%;color:#4b3324;text-shadow:0 1px 0 #dab59c;-moz-opacity:.6;-khtml-opacity:.6;opacity:.6;-moz-transition:all .4s;-webkit-transition:all .4s;-o-transition:all .4s;transition:all .4s}footer:hover{-moz-opacity:1;-khtml-opacity:1;opacity:1}footer a:link,footer a:visited{color:#7b1232;text-decoration:none;border-bottom:dotted 1px #aa214b}footer a:hover{color:#aa214b}footer a:active{top:1px;position:relative}#enabled{margin-bottom:2%}footer label{vertical-align:6%;cursor:pointer}.twitter-share-button{vertical-align:-15%;margin-right:-25px!important}.logo{border-bottom:none!important;-moz-opacity:.3;-khtml-opacity:.3;opacity:.3;padding:15px;display:inline-block;-moz-transition:all .4s;-webkit-transition:all .4s;-o-transition:all .4s;transition:all .4s}.logo:hover{-moz-opacity:1;-khtml-opacity:1;opacity:1}</style>"""
  html = u"""<!doctype html><head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Light Switch with CSS3 &amp; HTML5</title> <meta name="author" content="https://plus.google.com/116801469202683881648/"/> <meta name="viewport" content="width=device-width, initial-scale=0.55"/>"""+css+"""</head><body> <button> <span> <b>I</b> <b>O</b> </span> </button> <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script> <script type="text/javascript">/* iOS re-orientation fix */ if (navigator.userAgent.match(/iPhone/i) || navigator.userAgent.match(/iPad/i)){var viewportmeta=document.querySelectorAll('meta[name="viewport"]')[0]; if (viewportmeta){viewportmeta.content='width=device-width, minimum-scale=1.0, maximum-scale=1.0'; document.body.addEventListener('gesturestart', function(){viewportmeta.content='width=device-width, minimum-scale=0.25, maximum-scale=1.6';}, false);}/* iOS hides Safari address bar */ window.addEventListener("load",function()"""+r"""{setTimeout(function(){window"""+""".scrollTo(0, 1);}"""+""", 1000);});}var state="""+gpio_state+"""; if (state==0){$("button").toggleClass("off");}else if (state==1){$("button").removeClass();}$(document).ready(function(){/* on button click, toggle class "OFF" for the switch */ $("button").click(function (){if (state==1){$("button").toggleClass("off"); window.location.href='/?led=off';}else if (state==0){$("button").removeClass();window.location.href='/?led=on';"""+r"""}}"""+""");}); </script></body></html>"""
  return html

#conectando con el servidor
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind(('', 80))
s.listen(5)

#bucle de control
while True:
  #aceptando la conexion con el servidor
  conn, addr = s.accept()
  print('Got a connection from %s' % str(addr))
  request = conn.recv(1024)
  request = str(request)
  print('Content = %s' % request)
  
  #espera respuesta del precinar el boton aytavez del metodo GET
  led_on = request.find('/?led=on')
  led_off = request.find('/?led=off')
  
  #si la instruccion esta en la request se toma accion
  if led_on == 6:
    #print('LED ON')
    servo(27,0)
    led.value(1)
  if led_off == 6:
    #print('LED OFF')
    servo(27,135)
    led.value(0)
  #se recarga lapagina luego de tomar accion
  response = web_page()
  conn.send('HTTP/1.1 200 OK\n')
  conn.send('Content-Type: text/html\n')
  conn.send('Connection: close\n\n')
  conn.sendall(response)
  conn.close()